apiVersion: fn.kpt.dev/v1alpha1
kind: StarlarkRun
metadata:
  name: configure-porch-cache-type
  annotations:
    config.kubernetes.io/local-config: "true"
source: |-
  load("krmfn.star", "krmfn")
  def is_cr_cache(resources):
    for r in resources:
      if krmfn.match_gvk(r,"v1", "ConfigMap") and krmfn.match_namespace(r, "porch-system") and krmfn.match_name(r, "porch-config") and "cache-type" in r["data"]:
        if r["data"]["cache-type"].upper() == "CR":
          return True
        else:
          return False
    return False

  def remove_resource(resources, res_version, res_kind, res_ns, res_name):
    for i in range(len(resources)):
      r = resources[i]
      # Manual matching for StatefulSet since krmfn.match_gvk seems to fail
      if res_kind == "StatefulSet":
        if (r.get("apiVersion") == res_version and 
            r.get("kind") == res_kind and 
            r.get("metadata", {}).get("namespace") == res_ns and 
            r.get("metadata", {}).get("name") == res_name):
          resources.pop(i)
          print("Removed " + res_kind + " " + res_name)
          return
      else:
        # Use krmfn functions for other resources
        if krmfn.match_gvk(r, res_version, res_kind) and krmfn.match_namespace(r, res_ns) and krmfn.match_name(r, res_name):
          resources.pop(i)
          print("Removed " + res_kind + " " + res_name)
          return

  def remove_db_config_from_deployment(resources):
    for resource in resources:
        if (resource.get("kind") == "Deployment" and 
            resource.get("metadata", {}).get("name") == "porch-server" and
            resource.get("metadata", {}).get("namespace") == "porch-system"):
            
            podspec = resource["spec"]["template"]["spec"]

            # Remove wait-for-postgres initContainer
            if "initContainers" in podspec:
                new_init = []
                for c in podspec["initContainers"]:
                    if c.get("name") != "wait-for-postgres":
                        new_init.append(c)
                if new_init:
                    podspec["initContainers"] = new_init
                else:
                    podspec.pop("initContainers")

            # Update containers
            for container in podspec.get("containers", []):
                if "envFrom" in container:
                    container["envFrom"] = []
                
                args = container.get("args", [])
                for i, arg in enumerate(args):
                    if arg.startswith("--cache-type="):
                        args[i] = "--cache-type=cr"
  
  if is_cr_cache(ctx.resource_list["items"]):
    print("Configuring porch for CR cache")
    remove_db_config_from_deployment(ctx.resource_list["items"])
    remove_resource(ctx.resource_list["items"], "v1", "ConfigMap", "porch-system", "porch-db-schema")
    remove_resource(ctx.resource_list["items"], "v1", "Secret", "porch-system", "porch-db-secret")
    remove_resource(ctx.resource_list["items"], "v1", "ConfigMap", "porch-system", "porch-db-config")
    remove_resource(ctx.resource_list["items"], "v1", "Service", "porch-system", "porch-postgresql-lb")
    remove_resource(ctx.resource_list["items"], "v1", "Service", "porch-system", "porch-postgresql")
    remove_resource(ctx.resource_list["items"], "apps/v1", "StatefulSet", "porch-system", "porch-postgresql")
  else:
    print("Configuring porch for DB cache")