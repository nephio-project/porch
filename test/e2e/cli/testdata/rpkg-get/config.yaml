commands:
  - args:
      - porchctl
      - repo
      - register
      - --repo-basic-password=secret
      - --repo-basic-username=nephio
      - http://gitea.gitea.svc.cluster.local:3000/nephio/test-blueprints.git
      - --namespace=rpkg-get
      - --name=test-blueprints
      - --description
      - Test Blueprints
  - args:
      - porchctl
      - rpkg
      - get
      - --namespace=rpkg-get
      - --output=custom-columns=NAME:.metadata.name,PKG:.spec.packageName,REPO:.spec.repository,REV:.spec.revision
    stdout: |
      NAME                                PKG            REPO              REV
      test-blueprints.basens.main         basens         test-blueprints   -1
      test-blueprints.basens.v1           basens         test-blueprints   1
      test-blueprints.basens.v2           basens         test-blueprints   2
      test-blueprints.basens.v3           basens         test-blueprints   3
      test-blueprints.basens.v4           basens         test-blueprints   4
      test-blueprints.bucket.main         bucket         test-blueprints   -1
      test-blueprints.bucket.v1           bucket         test-blueprints   1
      test-blueprints.empty.main          empty          test-blueprints   -1
      test-blueprints.empty.v1            empty          test-blueprints   1
      test-blueprints.redis-bucket.main   redis-bucket   test-blueprints   -1
      test-blueprints.redis-bucket.v1     redis-bucket   test-blueprints   1
      test-blueprints.unready.main        unready        test-blueprints   -1
      test-blueprints.unready.v1          unready        test-blueprints   1
      test-blueprints.update.main         update         test-blueprints   -1
      test-blueprints.update.v1           update         test-blueprints   1
      test-blueprints.update.v2           update         test-blueprints   2
  - args:
      - porchctl
      - rpkg
      - get
      - --namespace=rpkg-get
      - test-blueprints.basens.v1
    stdout: |
      NAME                        PACKAGE   WORKSPACENAME   REVISION   LATEST   LIFECYCLE   REPOSITORY
      test-blueprints.basens.v1   basens    v1              1          false    Published   test-blueprints
  - args:
      - porchctl
      - rpkg
      - get
      - --namespace=rpkg-get
      - --name=basens
    stdout: |
      NAME                          PACKAGE   WORKSPACENAME   REVISION   LATEST   LIFECYCLE   REPOSITORY
      test-blueprints.basens.main   basens    main            -1         false    Published   test-blueprints
      test-blueprints.basens.v1     basens    v1              1          false    Published   test-blueprints
      test-blueprints.basens.v2     basens    v2              2          false    Published   test-blueprints
      test-blueprints.basens.v3     basens    v3              3          false    Published   test-blueprints
      test-blueprints.basens.v4     basens    v4              4          true     Published   test-blueprints
  - args:
      - porchctl
      - repo
      - register
      - --namespace=rpkg-get
      - --name=git
      - --repo-basic-password=secret
      - --repo-basic-username=nephio
      - http://gitea.gitea.svc.cluster.local:3000/nephio/rpkg-get
  - args:
      - porchctl
      - rpkg
      - init
      - --namespace=rpkg-get
      - --repository=git
      - --workspace=get
      - get-package-render-failed
    stdout: |
      git.get-package-render-failed.get created
  - args:
      - porchctl
      - rpkg
      - pull
      - --namespace=rpkg-get
      - git.get-package-render-failed.get
      - /tmp/porch-e2e/testing-invalid-render-get
  - args:
      - sh
      - -c
      - |
        echo "pipeline:\n  mutators:\n  - image: ghcr.io/kptdev/krm-functions-catalog/set-namespace:v0.4.0\n    configMap:\n      namespace: example-ns\n  - image: ghcr.io/kptdev/krm-functions-catalog/set-annotations:v0.1.4\n" >> /tmp/porch-e2e/testing-invalid-render-get/Kptfile
  - args:
      - porchctl
      - rpkg
      - push
      - --namespace=rpkg-get
      - git.get-package-render-failed.get
      - /tmp/porch-e2e/testing-invalid-render-get
    stdout: |
      git.get-package-render-failed.get pushed (non-rendered resources only; rendered resources NOT pushed due to render failure)
    stderr: "Package is updated, but failed to render the package."
    containsErrorString: true
    exitCode: 0
  - args:
      - porchctl
      - rpkg
      - get
      - --namespace=rpkg-get
      - git.get-package-render-failed.get
      - --output=custom-columns=NAME:.metadata.name,RENDER-RESULT-EXITCODE:.status.renderStatus.result.exitCode
    stdOutNewlineToWhitespace: true
    stdout: |
      NAME                                RENDER-RESULT-EXITCODE
      git.get-package-render-failed.get   1
